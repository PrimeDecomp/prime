#include "musyx/synth.h"


static float toneup_tab[128] = {
    1.0f,       1.0594635f, 1.1224623f, 1.1892071f,  1.2599211f,  1.3348398f,  1.4142141f,
    1.4983072f, 1.5874014f, 1.6817932f, 1.7817984f,  1.8877487f,  2.000001f,   2.118927f,
    2.2449245f, 2.378415f,  2.519843f,  2.6696806f,  2.8284283f,  2.9966154f,  3.1748037f,
    3.3635874f, 3.5635967f, 3.7754984f, 4.000002f,   4.237854f,   4.48985f,    4.75683f,
    5.039686f,  5.339362f,  5.6568565f, 5.993231f,   6.3496075f,  6.7271748f,  7.1271935f,
    7.5509977f, 8.000004f,  8.475709f,  8.979701f,   9.513661f,   10.079373f,  10.678724f,
    11.313714f, 11.986463f, 12.699215f, 13.4543495f, 14.254387f,  15.101996f,  16.000008f,
    16.951418f, 17.959402f, 19.027323f, 20.158747f,  21.357449f,  22.627428f,  23.972925f,
    25.39843f,  26.908699f, 28.508774f, 30.203993f,  32.000015f,  33.902836f,  35.918804f,
    38.054646f, 40.317493f, 42.714897f, 45.254856f,  47.94585f,   50.79686f,   53.817398f,
    57.017548f, 60.407986f, 64.00003f,  67.80567f,   71.83761f,   76.10929f,   80.63499f,
    85.429794f, 90.50971f,  95.8917f,   101.59372f,  107.634796f, 114.035095f, 120.81597f,
    128.00006f, 135.61134f, 143.67522f, 152.21858f,  161.26997f,  170.85959f,  181.01942f,
    191.7834f,  203.18744f, 215.26959f, 228.07019f,  241.63194f,  256.00012f,  271.2227f,
    287.35043f, 304.43716f, 322.53995f, 341.71918f,  362.03885f,  383.5668f,   406.37488f,
    430.53918f, 456.14038f, 483.2639f,  512.00024f,  542.4454f,   574.70087f,  608.8743f,
    645.0799f,  683.43835f, 724.0777f,  767.1336f,   812.74976f,  861.07837f,  912.28076f,
    966.5278f,  1024.0005f, 1084.8907f, 1149.4017f,  1217.7487f,  1290.1598f,  1366.8767f,
    1448.1554f, 1534.2672f,

};
static float tonedown_tab[128] = {
    1.0f,          0.94387436f,   0.8908987f,    0.8408966f,    0.7937002f,    0.74915314f,
    0.7071066f,    0.66741943f,   0.62996006f,   0.59460354f,   0.56123066f,   0.52973175f,
    0.5f,          0.47193718f,   0.44544888f,   0.4204483f,    0.3968506f,    0.37457657f,
    0.35355282f,   0.33370972f,   0.3149805f,    0.2973013f,    0.2806158f,    0.26486588f,
    0.25f,         0.23596859f,   0.22272491f,   0.21022415f,   0.1984253f,    0.18728828f,
    0.17677689f,   0.16685486f,   0.15748978f,   0.14865112f,   0.14030743f,   0.13243294f,
    0.125f,        0.11798382f,   0.11136246f,   0.105112076f,  0.09921265f,   0.09364414f,
    0.08838844f,   0.08342743f,   0.07874489f,   0.07432556f,   0.07015419f,   0.06621647f,
    0.0625f,       0.058992386f,  0.05568123f,   0.052556038f,  0.049606323f,  0.046822548f,
    0.04419422f,   0.041713715f,  0.039372444f,  0.03716278f,   0.035077095f,  0.033107758f,
    0.03125f,      0.029496193f,  0.027840614f,  0.026277542f,  0.024803162f,  0.023410797f,
    0.022096634f,  0.020856857f,  0.019686699f,  0.01858139f,   0.01753807f,   0.016553879f,
    0.015625f,     0.01474762f,   0.01391983f,   0.013138771f,  0.012401581f,  0.011705399f,
    0.011048317f,  0.010428429f,  0.009842873f,  0.009290695f,  0.008769035f,  0.008276939f,
    0.0078125f,    0.00737381f,   0.006959915f,  0.0065698624f, 0.0062007904f, 0.0058526993f,
    0.0055246353f, 0.005214691f,  0.004921913f,  0.0046453476f, 0.0043849945f, 0.0041389465f,
    0.00390625f,   0.003686905f,  0.0034799576f, 0.0032844543f, 0.0031003952f, 0.0029268265f,
    0.0027618408f, 0.0026073456f, 0.0024604797f, 0.002322197f,  0.0021924973f, 0.0020694733f,
    0.001953125f,  0.0018434525f, 0.0017404556f, 0.0016422272f, 0.0015497208f, 0.0014629364f,
    0.0013809204f, 0.0013036728f, 0.0012302399f, 0.0011615753f, 0.0010957718f, 0.0010347366f,
    9.765625E-4f,  9.2220306E-4f, 8.69751E-4f,   8.211136E-4f,  7.753372E-4f,  7.314682E-4f,
    6.904602E-4f,  6.5135956E-4f,

};

s32 sndPitchUpOne(u16 note) { return note * 1.0594631f; }

u32 sndGetPitch(u8 key, u32 sInfo) {
  u8 okey;   // r31
  float frq; // r63
  if (sInfo == 0xffffffff) {
    sInfo = 0x40005622;
  }

  okey = sInfo >> 24;

  if (key != okey) {
    frq = (float)(sInfo & 0xFFFFFF) *
          (okey < key ? toneup_tab[key - okey] : tonedown_tab[okey - key]);

  } else {
    frq = sInfo & 0xFFFFFF;
  }

  return (4096.f * frq) / synthInfo.mixFrq;
}
